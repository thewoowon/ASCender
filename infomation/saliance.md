++++++++++++++++++++++++++사전 정의 시작+++++++++++++++++++++++++++++++

<히스토리 스키마 제안>

{
  "turn": 0,
  "role": "agent",        // "agent" | "user"
  "text": "",             // 사용자 또는 에이전트의 발화 내용
  "verdict": "",          // 아래 표준 라벨 참조
  "axes": {               // 0.00 ~ 1.00 실수
    "authority": 0,       // 권위복종 (검찰/경찰 등)
    "urgency": 0,         // 시간압박 취약 (즉시 조치 요구 등)
    "link_trust": 0,      // 링크/첨부 신뢰 (도메인 확인 없이 클릭 등)
    "no_callback": 0      // 역조회 부재 (대표번호 확인·콜백 제안 없음)
  },
  "salience": 0,          // 0.00 ~ 1.00 실수 (서버 최종 계산)
  "evidence": ""          // 1문장 또는 1문구, 최대 ~80자 권장
}

<고정형(1~3턴)>
- 서버의 룰 기반으로 verdict/axes/salience를 산정할 것 -> 일관성·저비용
- LLM은 선택적으로 감정·근거 문구(evidence) 생성에만 사용

<적응형(4~7턴)> 
- LLM이 1차 산정(자유서술 해석) → 서버에서 정규화/증감제한/클리핑으로 보정.
- 정규화는 축 벡터 합이 3.0을 넘으면 비율로 스케일 다운.
- salience는 서버에서 Recency + Error + AxisMax로 최종 계산.
- 클리핑의 경우 축별 0.00~1.00 범위로 자르기.

<모든 턴> 
- salience는 선형 결합(Recency + 위험반응 + 축최댓값)으로 서버가 최종 계산(일관성 확보).

formula 제안
- salience = 0.4 * recency + 0.4 * error + 0.2 * axis_max

민감정보(RRN/계좌) 처리 방법 필요하겠네요.

++++++++++++++++++++++++++사전 정의 끝+++++++++++++++++++++++++++++++

++++++++++++++++++++++++++라벨 정의 (verdict) 시작+++++++++++++++++++++++++++++++

<user 턴>

- safe(올바른 대응: 역조회 제안/거절/기관 대표번호 요구)
- risky(모호한 동의/링크 검증 없이 탐색)
- unsafe(민감정보 제공/즉시 클릭·이체 수락)
- neutral(잡담/판단 불가)

<agent 턴>

- bait(미끼 깔기: 신분/사건 프레이밍)
- pressure(시간·형사처벌 압박)
- request_pi(개인·계좌 정보요구)
- send_link(링크/파일 유도)

++++++++++++++++++++++++++라벨 정의 (verdict) 끝+++++++++++++++++++++++++++++++

++++++++++++++++++++++++++축(axes) 의미 & 채점 원칙 시작+++++++++++++++++++++++++++++++

축(axes) 의미 & 채점 원칙

- authority -> 권위복종: “검찰/경찰/공문” 등 권위 호소에 시인/무조건 복종 성향
- urgency -> 시간압박 취약: “5분 내/즉시 동결” 같은 압박에 즉답/서두름
- link_trust -> 링크/첨부 신뢰: 도메인 확인 없이 클릭/다운로드 의향
- no_callback -> 역조회 부재: 대표번호 확인·콜백 제안이 없음

즉,값 범위: 0.00\~1.00(연속형)
이는 각 축의 취약성 정도를 나타낸 것으로 서버에서 계산하면 좋겠네요~

++++++++++++++++++++++++++축(axes) 의미 & 채점 원칙 끝+++++++++++++++++++++++++++++++

++++++++++++++++++++++++++서버 룰로 값 정하기 시작+++++++++++++++++++++++++++++++

2) verdict>

버튼 선택지에 규칙을 미리 고정하고 바로 `verdict`를 정하는 방식입니다!

- “대표번호로 확인하겠습니다” → "safe"
- “사건번호만 다시요/바로 따라가겠습니다” → "risky"
- “주민번호 알려줄게요/링크 바로 눌러요” → "unsafe"

2) axes (룰 테이블 자체적으로 만들기, 고민필요)

배열의 길이는 4로 고정, 미리 정해진 점수 배분으로 결정.

array -> [authority, urgency, link_trust, no_callback]

대표번호 역조회/콜백 제안 -> [0.10, 0.10, 0.00, 0.00]
사건번호 재확인만(역조회 無) -> [0.60, 0.40, 0.10, 0.70]
시간압박에 즉답 -> [0.50, 0.80, 0.10, 0.60]
링크/파일 클릭 의향 -> [0.50, 0.50, 0.80, 0.70]
민감정보 제공 의향 -> [0.70, 0.60, 0.30, 0.85]

이건 예시로, 실제 룰 테이블은 더 세분화할 수 있습니다(추후 논의 해보시죠!)

혹시 여러 속성에 해당되면 최대값 기준으로 합성
(예: “사건번호 재확인 + 시간압박 즉답” → [0.60, 0.80, 0.10, 0.70])

3) salience (서버 계산식)

턴 번호를 t, 최신 턴과의 거리 d(0=최신)라 할 때
(예: t=0이면 d=0, t=1이면 d=1, ...)
즉 최근이라면 d=0, 이전 턴이면 d=1 등으로 정의하는 것.


recency(t) = 1 / (1 + d)
axis_max(t) = max(authority, urgency, link_trust, no_callback)

error(t)는 function으로 정의해볼게요~

error(t) = () => {
    if (verdict === 'risky' || verdict === 'unsafe') {
        return 1;
    } else {
        return 0;
    }
}

최종 선형 결합

salience(t) = 0.4 * recency(t) + 0.4 * error(t) + 0.2 * axis_max(t)

- 값은 0~1로 clip(자르기)
- 고정형 1~3턴은 대개 d가 커지기 때문에 recency가 낮게 나옴

4) evidence

사용자 핵심 문구 1개 또는 행동 요약 1문장 -> 이건 논의가 필요할 것 같아요.
예시: “역조회 언급 없이 신원 검증에 응함” 또는 “사건번호 재확인만 수행”

++++++++++++++++++++++++++서버 룰로 값 정하기 끝+++++++++++++++++++++++++++++++

++++++++++++++++++++++++++적응형(4~7턴) 시작+++++++++++++++++++++++++++++++

LLM에 아래 JSON만 내도록 프롬프트 구성

{
  "verdict": "safe|risky|unsafe|neutral",
  "axes": { "authority": 0.73, "urgency": 0.40, "link_trust": 0.15, "no_callback": 0.90 },
  "evidence": "대표번호 역조회 언급 없이 신원 검증에 응함"
}

- 입력: 최근 1~2턴 원문 + 그 이전 턴은 “요약+이전축” 형태

2) 서버 보정 규칙(중요!합니다)

- 클리핑: 축별 0~1 범위로 자르기.
- 증감제한: 같은 축은 턴당 ±0.25p 이내 변화 -> 이상치 방지.
  * 예: 이전 턴 authority=0.50, 현재 0.80이면 0.75로 조정.
- 정규화: 축 벡터 합이 3.0을 넘으면 비율로 스케일 다운.

이후 salience는 항상 서버가 위 식으로 재계산

3) verdict 가이드

-> LLM이 자유서술을 해석하여 판단하는 방식입니다.

- unsafe: 민감정보 제공/즉시 클릭·이체 수락 의사 표현
- risky: 역조회 부재·시간압박에 동조·링크 검증 없이 긍정적 반응
- safe: 대표번호 확인·콜백 제안·거절·지연 요구
- neutral: 의미 해석 불가/잡담

4) evidence 선정 규칙

- 사용자 문장 인용 또는 패러프레이즈 1개
- 행동 근거 1개(예: “역조회 언급 없음”)
- 80자 이내, 과도한 설명 금지 -> 80자 기준은 자유롭게 설정해보죠!

++++++++++++++++++++++++++적응형(4~7턴) 끝+++++++++++++++++++++++++++++++

++++++++++++++++++++++++++역할별 채점 원칙 시작+++++++++++++++++++++++++++++++

user 턴만 점수화하고 agent 턴은 verdict만으로도 충분할 것 같습니다.

++++++++++++++++++++++++++역할별 채점 원칙 끝+++++++++++++++++++++++++++++++

++++++++++++++++++++++++++예시 시작+++++++++++++++++++++++++++++++

<고정형 턴 예>

{
  "turn": 2,
  "role": "user",
  "text": "사건번호 다시 알려주세요. 확인해볼게요.",
  "verdict": "risky",
  "axes": { "authority": 0.60, "urgency": 0.40, "link_trust": 0.10, "no_callback": 0.70 },
  "salience": 0.70,
  "evidence": "대표번호 역조회 없이 사건번호 재확인만 수행"
}

<적응형 턴 예>

{
  "turn": 4,
  "role": "user",
  "text": "제 주민번호는 970101-1****** 입니다. 어떻게 해야 하죠?",
  "verdict": "unsafe",
  "axes": { "authority": 0.72, "urgency": 0.58, "link_trust": 0.20, "no_callback": 0.88 },
  "salience": 0.83,
  "evidence": "역조회 없이 신원 정보 제공 의사 표명"
}

++++++++++++++++++++++++++예시 시작+++++++++++++++++++++++++++++++

++++++++++++++++++++++++++구현 순서 시작+++++++++++++++++++++++++++++++

1. 입력 수집: 최신 agent→user 교환 쌍 수집,

2. 고정/적응 분기
- 고정형(1~3): 룰 테이블로 verdict/axes 산정
- 적응형(4~7): LLM이 verdict/axes/evidence 산정

3. 서버 보정: 클리핑/증감제한/정규화

4. salience 계산: 서버 수식(Recency+Error+AxisMax)

5. 세션 요약 업데이트: 상위-k(예: 3) 턴 원문 유지, 나머지 1줄 요약
-> 토큰량에 부담이 없다면 그냥 전문 저장해도 좋을 것 같네요, 그냥 다 때려박는 것!

6. 다음 턴 정책 결정: 상위 취약축 (axes) 기준으로 결정

++++++++++++++++++++++++++구현 순서 끝+++++++++++++++++++++++++++++++